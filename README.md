# URL_Shortener
![Build](https://github.com/james5418/URL_Shortener/actions/workflows/docker.yml/badge.svg)
![License](https://img.shields.io/badge/License-MIT-blue.svg)

![](https://img.shields.io/static/v1?message=Node.js&logo=node.js&labelColor=5c5c5c&color=6DA55F&logoColor=green&label=%20&style=flate)
![](https://img.shields.io/static/v1?message=Express.js&logo=express&labelColor=5c5c5c&color=%23404d59&logoColor=%2361DAFB&label=%20&style=flate)
![](https://img.shields.io/static/v1?message=Redis&logo=redis&labelColor=5c5c5c&color=%23DD0031&logoColor=white&label=%20&style=flate)
![](https://img.shields.io/static/v1?message=Mocha&logo=mocha&labelColor=5c5c5c&color=%238D6748&logoColor=white&label=%20&style=flate)
![](https://img.shields.io/static/v1?message=Chai&logo=chai&labelColor=5c5c5c&color=A30701&logoColor=white&label=%20&style=flate)

<!-- ![Node.js](https://img.shields.io/badge/Node.js-6DA55F?&logo=node.js&logoColor=white)
![Express.js](https://img.shields.io/badge/Express.js-%23404d59.svg?&logo=express&logoColor=%2361DAFB)
![Redis](https://img.shields.io/badge/Redis-%23DD0031.svg?logo=redis&logoColor=white)
![Mocha](https://img.shields.io/badge/-Mocha-%238D6748?&logo=mocha&logoColor=white) 
![Chai](https://img.shields.io/badge/Chai-A30701?&logo=chai&logoColor=white)

![](https://img.shields.io/badge/Node.js-✓-green.svg)
![](https://img.shields.io/badge/Express.js-✓-blue.svg)
![](https://img.shields.io/badge/Redis-✓-red.svg)
![](https://img.shields.io/badge/Mocha-✓-brown.svg)
![](https://img.shields.io/badge/Chai-✓-orange.svg) -->

### Yet Another URL Shortening Service

## Features
| HTTP Type | API URL      | Comments                                         |
| --------- | ------------ | ------------------------------------------------ |
| POST      | /api/v1/urls | Generate a short URL based on the given URL      |
| GET       | /<url_id>    | Redirect to original URL by <url_id>             |
| GET       | /show        | Get all short URLs and their original URLs       |

## Usage

Short URL Generation
```shell
curl -X POST -H "Content-Type:application/json" http://localhost:8000/api/v1/urls -d '{
"url": "<original_url>",
"expireAt": "YYYY-MM-DDTHH:mm:ssZ"
}'
```

> Response
```json
{
"id": "<url_id>",
"shortUrl": "http://localhost:8000/<url_id>"
}
```

Short URL Redirection
```
curl -L -X GET http://localhost:8000/<url_id>
```

Show URLs mapping
```
curl -L -X GET http://localhost:8000/show
```


## Getting Started

Get project dependencies
```
npm install
```
Run server
```
npm start
```
Redis startup
```
sudo service redis-server start
```
Unit Test 
```
npm test
```

## Workflow

### APIs
The URL Shortener works in two APIs

#### 1. Generate a short URL based on the given URL
- For incoming requests, the server will first check the legitimacy of input URLs and expired dates.
- If requests are valid, the server will generate a unique, random identifier `url_id`, assign it to the original URL, and then store them with their expired date in the database using hashes. (`url_id` is the key)
- For generating `url_id`, we use [nanoid](https://github.com/ai/nanoid) because it is fast and secure.
  - Tokens generated by nanoid have 10 digits ⇒ 64^10 different URLs
```javascript
router.post('/', async(req, res) => {
    try{
        const {url, expireAt} = req.body;

        if(!isUrl(url)){
            res.status(400).send("Invalid URL!");
        }
        else if(!check_date(expireAt)){
            res.status(400).send("Invaild expired date!");
        }
        else{
            const shortURL = nanoid(10);
            
            await client.hSet(shortURL, [
                'url', url,
                'expireAt', expireAt,
            ]);
        
            res.status(200).json({"id" : shortURL, "shortUrl" : `http://localhost:${PORT}/${shortURL}`});
        }
    }
    catch(err){
        res.status(500).json(err);
    }
});
```

#### 2. Redirect short URL to original URL
- When users send requests by short URLs, the server will look up in the database by its corresponding `url_id` to check whether that short URL exists.
- If there is an existing short URL entry in the cache and the expired date of that short URL is still valid (not expired), the server will redirect users to the original URL.
- If the short URL does not exist, the server will respond with status 404 and also record it to the cache.

> Since clients may access the server simultaneously and the expired date for the same short URL can be different, it makes sense to store many pairs of different short URLs with the same original URL in the database.

```javascript
router.get('/:id', async(req, res) => {
    try{
        const url_id = req.params.id;
        const long_url = await client.hGetAll(url_id);

        if(long_url.url && check_date(long_url.expireAt)){
            res.redirect(long_url.url);
        }
        else{
            await client.hSet(url_id, [
                'url', null,
                'expireAt', null,
            ]);

            res.status(404).send(`http://localhost:${PORT}/${url_id} not found`);
        }
    }
    catch(err){
        res.status(500).json(err);
    }
});
```

### Database — Redis
Why Redis
- As an in-memory database, Redis is super fast and performant, which makes the application itself faster.
- Redis key value-based database is suitable for this project, this is, saving URLs mapping.
- We can store data in Redis using hashes.
    - Small hashes are encoded in a very small space.
    - When N is small, the amortized time for HGETALL and HSET commands is still **O(1)**.
- Using a separate database like MongoDB in addition to using Redis would add more complexity and compromises latency. Actually, apart from a caching database, Redis has since evolved into a primary database nowadays.

### Testing — Mocha and Chai

#### Function
✔ Examine `check_date()` function works correctly

#### POST API
✔ POST http&#65279;://localhost:8000/api/v1/urls

✔ POST request with wrong variable name

✔ POST request with invalid URL

✔ POST request with invalid expired date (wrong format)

✔ POST request with invalid expired date (already expired)


#### GET API
✔ GET http&#65279;://localhost:8000/<url_id>

✔ GET short url having non-existent id

✔ GET short url having already expired date

✔ GET http&#65279;://localhost:8000/show



